package org.example.quanlyhosobenhan.Controllers;

import javafx.beans.property.SimpleObjectProperty;
import javafx.beans.property.SimpleStringProperty;
import javafx.event.ActionEvent;
import javafx.fxml.FXML;
import javafx.geometry.Insets;
import javafx.geometry.Pos;
import javafx.scene.Scene;
import javafx.scene.control.*;
import javafx.scene.layout.HBox;
import javafx.scene.layout.VBox;
import javafx.scene.text.Text;
import javafx.stage.Stage;
import javafx.util.StringConverter;
import org.example.quanlyhosobenhan.Dao.PatientDAO;
import org.example.quanlyhosobenhan.Model.Patient;

import java.time.LocalDate;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Locale;
import java.util.function.Function;
import java.util.regex.Pattern;
import java.util.stream.Collectors;

public class StaffPatientManagementController {

    @FXML
    private TableColumn<Patient, String> addressColumn;

    @FXML
    private TextArea addressField;

    @FXML
    private TableColumn<Patient, String> dobColumn;

    @FXML
    private DatePicker dobField;

    @FXML
    private TableColumn<Patient, String> emailColumn;

    @FXML
    private TextField emailField;

    @FXML
    private DatePicker endDatePicker;

    @FXML
    private TextField fullNameField;

    @FXML
    private TableColumn<Patient, Patient.Gender> genderColumn;

    @FXML
    private ComboBox<Patient.Gender> genderField;

    @FXML
    private TableColumn<Patient, Integer> idColumn;

    @FXML
    private TableColumn<Patient, String> nameColumn;

    @FXML
    private TableView<Patient> patientTable;

    @FXML
    private TableColumn<Patient, String> phoneNumberColumn;

    @FXML
    private TextField phoneNumberField;

    @FXML
    private TextField searchTextField;

    @FXML
    private DatePicker startDatePicker;


    private static final DateTimeFormatter VIETNAMESE_DATE_FORMATTER =
            DateTimeFormatter.ofPattern("dd-MM-yyyy", Locale.forLanguageTag("vi-VN"));

    private static final String EMAIL_REGEX = "^[A-Za-z0-9+_.-]+@[A-Za-z0-9.-]+\\.[A-Za-z]{3,6}$";

    private static final Pattern EMAIL_PATTERN = Pattern.compile(EMAIL_REGEX);

    private PatientDAO patientDAO = new PatientDAO();

    @FXML
    public void initialize() {
        patientTable.setPlaceholder(new Label("‚ùå Kh√¥ng c√≥ b·ªánh nh√¢n."));

        idColumn.setCellValueFactory(cellData
                -> new SimpleObjectProperty<>(cellData.getValue().getId()));

        nameColumn.setCellValueFactory(cellData
                -> new SimpleStringProperty(cellData.getValue().getFullName()));
        setupEllipsisColumn(nameColumn, "Chi ti·∫øt t√™n");

        genderColumn.setCellValueFactory(cellData
                -> new SimpleObjectProperty<>(cellData.getValue().getGender()));

        dobColumn.setCellValueFactory(cellData -> {
            LocalDate birthdate = cellData.getValue().getBirthdate();
            String formattedDate = birthdate != null ? birthdate.format(VIETNAMESE_DATE_FORMATTER) : "";
            return new SimpleStringProperty(formattedDate);
        });

        addressColumn.setCellValueFactory(cellData
                -> new SimpleStringProperty(cellData.getValue().getAddress()));
        setupEllipsisColumn(addressColumn, "Chi ti·∫øt ƒë·ªãa ch·ªâ");

        emailColumn.setCellValueFactory(cellData
                -> new SimpleStringProperty(cellData.getValue().getEmail()));
        setupEllipsisColumn(emailColumn, "Chi ti·∫øt email");

        phoneNumberColumn.setCellValueFactory(cellData
                -> new SimpleStringProperty(cellData.getValue().getPhone()));

        genderField.getItems().setAll(Patient.Gender.values());

        refreshTable();

        // ƒê·ªãnh d·∫°ng ng√†y hi·ªÉn th·ªã theo dd-MM-yyyy
        DateTimeFormatter dateFormatter = DateTimeFormatter.ofPattern("dd-MM-yyyy");
        StringConverter<LocalDate> converter = new StringConverter<>() {
            @Override
            public String toString(LocalDate date) {
                return date != null ? dateFormatter.format(date) : "";
            }

            @Override
            public LocalDate fromString(String string) {
                if (string == null || string.trim().isEmpty()) {
                    return null;
                }
                return LocalDate.parse(string, dateFormatter);
            }
        };

        // X·ª≠ l√Ω t√¨m ki·∫øm
        searchTextField.textProperty().addListener((observable, oldValue, newValue) -> {
            filterRecordsCombined(newValue);
        });

        startDatePicker.setConverter(converter);
        endDatePicker.setConverter(converter);

        // Xu ly chon khoang ngay sinh
        startDatePicker.valueProperty().addListener((obs, oldDate, newDate) -> {
            filterRecordsCombined(searchTextField.getText());
        });
        endDatePicker.valueProperty().addListener((obs, oldDate, newDate) ->{
            filterRecordsCombined(searchTextField.getText());
        });
        // B·ªï sung x·ª≠ l√Ω khi ng∆∞·ªùi d√πng x√≥a ng√†y b·∫±ng b√†n ph√≠m r·ªìi r·ªùi focus
        startDatePicker.focusedProperty().addListener((obs, oldFocus, newFocus) -> {
            if (!newFocus) { // Khi m·∫•t focus
                filterRecordsCombined(searchTextField.getText());
            }
        });
        endDatePicker.focusedProperty().addListener((obs, oldFocus, newFocus) -> {
            if (!newFocus) {
                filterRecordsCombined(searchTextField.getText());
            }
        });

        patientTable.setOnMouseClicked(event -> {
            if (event.getClickCount() == 2) {
                Patient selectedPatient = patientTable.getSelectionModel().getSelectedItem();
                if (selectedPatient != null) {
                    showPatientDetails(selectedPatient);
                }
            }
        });

        patientTable.getSelectionModel().selectedItemProperty().addListener((obs, oldSelection, newSelection) -> {
            if (newSelection != null) {
                fullNameField.setText(newSelection.getFullName());
                addressField.setText(newSelection.getAddress());
                emailField.setText(newSelection.getEmail());
                phoneNumberField.setText(newSelection.getPhone());
                dobField.setValue(newSelection.getBirthdate());
                genderField.setValue(newSelection.getGender());
            }
        });

    }

    private void showPatientDetails(Patient selectedPatient) {
        Stage detailsStage = new Stage();
        detailsStage.setTitle("Th√¥ng tin chi ti·∫øt b·ªánh nh√¢n");

        VBox vbox = new VBox(10);
        vbox.setPadding(new Insets(20));
        vbox.setPrefWidth(500);

        Function<String, Label> createWrappedLabel = (text) -> {
            Label label = new Label(text);
            label.setWrapText(true);
            if (text.length() > 50) {
                Tooltip tooltip = new Tooltip(text);
                tooltip.setWrapText(true);
                tooltip.setMaxWidth(400);
                Tooltip.install(label, tooltip);
            }
            return label;
        };

        vbox.getChildren().addAll(
                createWrappedLabel.apply("üÜî ID: " + selectedPatient.getId()),
                createWrappedLabel.apply("üë§ H·ªç t√™n: " + selectedPatient.getFullName()),
                createWrappedLabel.apply("üöª Gi·ªõi t√≠nh: " + selectedPatient.getGender()),
                createWrappedLabel.apply("üéÇ Ng√†y sinh: " + selectedPatient.getBirthdate().format(VIETNAMESE_DATE_FORMATTER)),
                createWrappedLabel.apply("üè† ƒê·ªãa ch·ªâ: " + selectedPatient.getAddress()),
                createWrappedLabel.apply("üìß Email: " + selectedPatient.getEmail()),
                createWrappedLabel.apply("üìû S·ªë ƒëi·ªán tho·∫°i: " + selectedPatient.getPhone()),
                createWrappedLabel.apply("üÜî S·ªë CCCD: " + selectedPatient.getNationalId()),
                createWrappedLabel.apply("üí≥ S·ªë th·∫ª BHYT: " + selectedPatient.getHealthInsuranceId())
        );

        Button closeBtn = new Button("ƒê√≥ng");
        closeBtn.setOnAction(e -> detailsStage.close());

        HBox buttonBox = new HBox(closeBtn);
        buttonBox.setAlignment(Pos.CENTER_RIGHT);
        vbox.getChildren().add(buttonBox);

        Scene scene = new Scene(vbox);
        detailsStage.setScene(scene);
        detailsStage.show();
    }

    @FXML
    void update(ActionEvent event) {
        Patient selectedPatient = patientTable.getSelectionModel().getSelectedItem();
        if (selectedPatient == null) {
            showAlert(Alert.AlertType.ERROR, "L·ªói","Vui l√≤ng ch·ªçn b·ªánh nh√¢n c·∫ßn c·∫≠p nh·∫≠t.");
            return;
        }

        if(fullNameField.getText().isEmpty() || addressField.getText().isEmpty() || emailField.getText().isEmpty()
                || phoneNumberField.getText().isEmpty() || dobField.getValue() == null || genderField.getValue() == null){
            showAlert(Alert.AlertType.ERROR, "L·ªói","Vui l√≤ng ƒëi·ªÅn ƒë·∫ßy ƒë·ªß th√¥ng tin!");
            return;
        }

        if(!isValidEmail(emailField.getText()) && !isValidPhoneNumber(phoneNumberField.getText())){
            showAlert(Alert.AlertType.ERROR, "L·ªói","Email v√† SƒêT kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p l·∫°i!");
            return;
        }

        if(!isValidEmail(emailField.getText())){
            showAlert(Alert.AlertType.ERROR, "L·ªói","Email kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p l·∫°i!");
            return;
        }

        if(!isValidPhoneNumber(phoneNumberField.getText())){
            showAlert(Alert.AlertType.ERROR, "L·ªói","SƒêT kh√¥ng h·ª£p l·ªá! Vui l√≤ng nh·∫≠p l·∫°i!");
            return;
        }

        selectedPatient.setFullName(fullNameField.getText());
        selectedPatient.setAddress(addressField.getText());
        selectedPatient.setEmail(emailField.getText());
        selectedPatient.setPhone(phoneNumberField.getText());
        selectedPatient.setBirthdate(dobField.getValue());
        selectedPatient.setGender(genderField.getSelectionModel().getSelectedItem());

        patientDAO.updatePatient(selectedPatient);
        showAlert(Alert.AlertType.INFORMATION, "Th√¥ng b√°o", "S·ª≠a th√¥ng tin th√†nh c√¥ng!");
        refreshTable();

        patientTable.getSelectionModel().clearSelection();

        fullNameField.clear();
        addressField.clear();
        emailField.clear();
        phoneNumberField.clear();
        dobField.setValue(null);
        genderField.getSelectionModel().clearSelection();

    }

//    @FXML
//    void delete(ActionEvent event) {
//        Patient selectedPatient = patientTable.getSelectionModel().getSelectedItem();
//        if(selectedPatient == null) {
//            showAlert(Alert.AlertType.ERROR, "L·ªói", "Vui l√≤ng ch·ªçn b·ªánh nh√¢n c·∫ßn x√≥a!");
//            return;
//        }
//        patientDAO.deletePatient(selectedPatient.getId());
//        showAlert(Alert.AlertType.INFORMATION, "Th√¥ng b√°o", "ƒê√£ x√≥a th√†nh c√¥ng!");
//        refreshTable();
//    }

    private void showAlert(Alert.AlertType alertType, String title, String content) {
        Alert alert = new Alert(alertType);
        alert.setTitle(title);
        alert.setHeaderText(null);
        alert.setContentText(content);
        alert.showAndWait();
    }

    private boolean isValidPhoneNumber(String phoneNumber) {
        String regex = "0\\d{9}";
        return phoneNumber != null && phoneNumber.matches(regex);
    }

    private boolean isValidEmail(String email) {
        if (email == null) return false;
        return EMAIL_PATTERN.matcher(email).matches();
    }

    private void refreshTable() {
        patientTable.getItems().clear();
        patientTable.getItems().addAll(patientDAO.getAllPatient());
    }

    // H√†m gi√∫p hi·ªÉn th·ªã n·ªôi dung khi n·ªôi dung vuot qu√° chieu d√†i c·ªßa c·ªôt
    private void setupEllipsisColumn(TableColumn<Patient, String> column, String dialogTitle) {
        column.setCellFactory(col -> new TableCell<>() {
            @Override
            protected void updateItem(String item, boolean empty) {
                super.updateItem(item, empty);
                if (empty || item == null) {
                    setText(null);
                    setTooltip(null);
                    setOnMouseClicked(null);
                    setStyle(""); // Reset l·∫°i style n·∫øu √¥ r·ªóng
                } else {
                    // ƒêo chi·ªÅu r·ªông vƒÉn b·∫£n th·ª±c t·∫ø
                    Text text = new Text(item);
                    text.setFont(getFont());
                    double textWidth = text.getLayoutBounds().getWidth();

                    //Chi·ªÅu r·ªông c·ªôt - padding (kho·∫£ng 10px m·∫∑c ƒë·ªãnh)
                    double cellWidth = column.getWidth() - 10;

                    // N·∫øu qu√° r·ªông, c·∫Øt d·∫ßn v√† th√™m "..."
                    if(textWidth > cellWidth) {
                        String shortened = item;
                        text.setText(shortened);
                        while(text.getLayoutBounds().getWidth() > cellWidth - 10 && shortened.length() > 0) {
                            shortened = shortened.substring(0, shortened.length() - 1);
                            text.setText(shortened + "...");
                        }
                        setText(shortened + "...");
                        setTooltip(new Tooltip("B·∫•m ƒë·ªÉ xem chi ti·∫øt"));
                        setStyle("-fx-cursor: hand;");
                        setOnMouseClicked(event -> {
                            if (event.getClickCount() == 1 && !isEmpty()) {
                                showDetailDialog(dialogTitle, item);
                            }
                        });
                    } else {
                        // N·∫øu ng·∫Øn, hi·ªÉn th·ªã b√¨nh th∆∞·ªùng, kh√¥ng c·∫ßn tooltip hay click
                        setText(item);
                        setTooltip(null);
                        setOnMouseClicked(null);
                        setStyle("");
                    }
                }
            }
        });
    }

    private void showDetailDialog(String title, String content) {
        Stage dialog = new Stage();
        dialog.setTitle(title);

        TextArea textArea = new TextArea(content);
        textArea.setWrapText(true);
        textArea.setEditable(false);
        textArea.setPrefSize(400, 200);

        Button closeButton = new Button("ƒê√≥ng");
        closeButton.setOnAction(e -> dialog.close());

        VBox vbox = new VBox(10, textArea, closeButton);
        vbox.setStyle("-fx-padding: 10;");
        Scene scene = new Scene(vbox);
        dialog.setScene(scene);
        dialog.initOwner(patientTable.getScene().getWindow());
        dialog.show();
    }

    // H√†m t√¨m ki·∫øm k·∫øt h·ª£p gi·ªØa t√¨m ki·∫øm v√† ch·ªçn kho·∫£ng ng√†y sinh
    private void filterRecordsCombined(String keyword) {
        LocalDate startDate = startDatePicker.getValue();
        LocalDate endDate = endDatePicker.getValue();

        PatientDAO patientDAO = new PatientDAO();
        List<Patient> allRecords = patientDAO.getPatientsByDoctorId(LoginController.loggedInDoctor.getId());

        List<Patient> filtered = allRecords.stream()
                .filter(patient -> {
                    LocalDate dob  = patient.getBirthdate();
                    if(dob  == null) return false;

                    // L·ªçc theo kho·∫£ng ng√†y ƒë∆∞·ª£c ch·ªçn
                    boolean afterOrEqualStart = (startDate == null || !dob .isBefore(startDate)); // consultationDate >= startDate
                    boolean beforeOrEqualEnd = (endDate == null || !dob .isAfter(endDate)); // consultationDate <= endDate
                    if(!(afterOrEqualStart && beforeOrEqualEnd))  return false;

                    // L·ªçc theo t·ª´ kh√≥a n·∫øu c√≥
                    if(keyword != null && !keyword.trim().isEmpty()) {
                        try {
                            int patientId = Integer.parseInt(keyword);
                            return patient.getId() == patientId;
                        } catch(NumberFormatException e) {
                            String combined = (
                                    (patient != null ? patient.getFullName() : "") + " " +
                                            patient.getGender() + " " +
                                            patient.getAddress() + " " +
                                            patient.getEmail() + " " +
                                            patient.getPhone() + " " +
                                            dob.toString() + " " +
                                            patient.getId()
                            ).toLowerCase();

                            return combined.contains(keyword.trim().toLowerCase());
                        }
                    }
                    return true; // Neu ko c√≥ t·ª´ kh√≥, ch·ªâ l·ªçc theo ng√†y
                }).collect(Collectors.toList());

        patientTable.getItems().setAll(filtered);
    }
}
